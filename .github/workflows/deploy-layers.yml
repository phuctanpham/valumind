name: Deploy Lambda Layers

on:
  workflow_dispatch:
  workflow_call:

jobs:

  detect-layer-changes:
    runs-on: ubuntu-latest
    outputs:
      shared: ${{ steps.changes.outputs.shared }}
      ml1: ${{ steps.changes.outputs.ml1 }}
      ml2: ${{ steps.changes.outputs.ml2 }}
      ml3: ${{ steps.changes.outputs.ml3 }}
      ocr1: ${{ steps.changes.outputs.ocr1 }}
      ocr2: ${{ steps.changes.outputs.ocr2 }}
      ocr3: ${{ steps.changes.outputs.ocr3 }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      
      - name: Detect changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "shared=true" >> $GITHUB_OUTPUT
            echo "ml1=true" >> $GITHUB_OUTPUT
            echo "ml2=true" >> $GITHUB_OUTPUT
            echo "ml3=true" >> $GITHUB_OUTPUT
            echo "ocr1=true" >> $GITHUB_OUTPUT
            echo "ocr2=true" >> $GITHUB_OUTPUT
            echo "ocr3=true" >> $GITHUB_OUTPUT
          else
            git diff --name-only HEAD~1 HEAD | grep -q "shared/shared_requirement_layer.txt" && echo "shared=true" >> $GITHUB_OUTPUT || echo "shared=false" >> $GITHUB_OUTPUT
            git diff --name-only HEAD~1 HEAD | grep -q "shared/ml_requirement_layer_1.txt" && echo "ml1=true" >> $GITHUB_OUTPUT || echo "ml1=false" >> $GITHUB_OUTPUT
            git diff --name-only HEAD~1 HEAD | grep -q "shared/ml_requirement_layer_2.txt" && echo "ml2=true" >> $GITHUB_OUTPUT || echo "ml2=false" >> $GITHUB_OUTPUT
            git diff --name-only HEAD~1 HEAD | grep -q "shared/ml_requirement_layer_3.txt" && echo "ml3=true" >> $GITHUB_OUTPUT || echo "ml3=false" >> $GITHUB_OUTPUT
            git diff --name-only HEAD~1 HEAD | grep -q "shared/ocr_requirement_layer_1.txt" && echo "ocr1=true" >> $GITHUB_OUTPUT || echo "ocr1=false" >> $GITHUB_OUTPUT
            git diff --name-only HEAD~1 HEAD | grep -q "shared/ocr_requirement_layer_2.txt" && echo "ocr2=true" >> $GITHUB_OUTPUT || echo "ocr2=false" >> $GITHUB_OUTPUT
            git diff --name-only HEAD~1 HEAD | grep -q "shared/ocr_requirement_layer_3.txt" && echo "ocr3=true" >> $GITHUB_OUTPUT || echo "ocr3=false" >> $GITHUB_OUTPUT
          fi

  deploy-shared-layer:
    needs: detect-layer-changes
    if: needs.detect-layer-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build layer
        run: |
          mkdir -p layer/python
          pip install --platform manylinux2014_x86_64 --only-binary=:all: \
            -r shared/shared_requirement_layer.txt -t layer/python
          cd layer
          zip -r9 ../layer.zip . -x "*.pyc" "*__pycache__*" "*.dist-info/*"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Publish layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name shared \
            --zip-file fileb://layer.zip \
            --compatible-runtimes python3.11 \
            --query 'LayerVersionArn' --output text)
          echo "âœ… Published: $LAYER_ARN"
          echo "SHARED_LAYER_ARN=$LAYER_ARN" >> $GITHUB_ENV

  deploy-ml1-layer:
    needs: detect-layer-changes
    if: needs.detect-layer-changes.outputs.ml1 == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build layer
        run: |
          mkdir -p layer/python
          pip install --platform manylinux2014_x86_64 --only-binary=:all: \
            -r shared/ml_requirement_layer_1.txt -t layer/python
          cd layer
          zip -r9 ../layer.zip . -x "*.pyc" "*__pycache__*" "*.dist-info/*"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Publish layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name ml1 \
            --zip-file fileb://layer.zip \
            --compatible-runtimes python3.11 \
            --query 'LayerVersionArn' --output text)
          echo "âœ… Published: $LAYER_ARN"

  deploy-ml2-layer:
    needs: detect-layer-changes
    if: needs.detect-layer-changes.outputs.ml2 == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build layer
        run: |
          mkdir -p layer/python
          pip install --platform manylinux2014_x86_64 --only-binary=:all: \
            -r shared/ml_requirement_layer_2.txt -t layer/python
          
          # Remove unnecessary files
          find layer/python -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find layer/python -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
          find layer/python -type f -name "*.pyc" -delete
          find layer/python -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          
          cd layer
          zip -r9 ../layer.zip . -x "*.pyc" "*__pycache__*" "*.dist-info/*"
      
      - name: Check layer size
        run: |
          SIZE_BYTES=$(stat -c%s layer.zip)
          SIZE_MB=$((SIZE_BYTES / 1024 / 1024))
          echo "ðŸ“¦ ML2 Layer size: ${SIZE_MB}MB (${SIZE_BYTES} bytes)"
          ls -lh layer.zip
          du -sh layer/python
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload to S3
        run: |
          aws s3 cp layer.zip s3://${{ secrets.AWS_BUCKET_NAME }}/layers/${{ secrets.ML2_LAYER_NAME }}.zip

      - name: Publish layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name "${{ secrets.ML2_LAYER_NAME }}" \
            --content S3Bucket=${{ secrets.AWS_BUCKET_NAME }},S3Key=layers/${{ secrets.ML2_LAYER_NAME }}.zip \
            --compatible-runtimes python3.11 \
            --query 'LayerVersionArn' --output text)
          echo "âœ… Published: $LAYER_ARN"

  deploy-ml3-layer:
    needs: detect-layer-changes
    if: needs.detect-layer-changes.outputs.ml3 == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build layer
        run: |
          mkdir -p layer/python
          pip install --platform manylinux2014_x86_64 --only-binary=:all: \
            -r shared/ml_requirement_layer_3.txt -t layer/python
          cd layer
          zip -r9 ../layer.zip . -x "*.pyc" "*__pycache__*" "*.dist-info/*"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Publish layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name ml3 \
            --zip-file fileb://layer.zip \
            --compatible-runtimes python3.11 \
            --query 'LayerVersionArn' --output text)
          echo "âœ… Published: $LAYER_ARN"

  deploy-ocr1-layer:
    needs: detect-layer-changes
    if: needs.detect-layer-changes.outputs.ocr1 == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build layer
        run: |
          mkdir -p layer/python
          pip install --platform manylinux2014_x86_64 --only-binary=:all: \
            -r shared/ocr_requirement_layer_1.txt -t layer/python
          cd layer
          zip -r9 ../layer.zip . -x "*.pyc" "*__pycache__*" "*.dist-info/*"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Publish layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name ocr1 \
            --zip-file fileb://layer.zip \
            --compatible-runtimes python3.11 \
            --query 'LayerVersionArn' --output text)
          echo "âœ… Published: $LAYER_ARN"

  deploy-ocr2-layer:
    needs: detect-layer-changes
    if: needs.detect-layer-changes.outputs.ocr2 == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build layer
        run: |
          mkdir -p layer/python
          pip install --platform manylinux2014_x86_64 --only-binary=:all: \
            -r shared/ocr_requirement_layer_3.txt -t layer/python
          
          # Remove unnecessary files
          find layer/python -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find layer/python -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
          find layer/python -type f -name "*.pyc" -delete
          find layer/python -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          
          cd layer
          zip -r9 ../layer.zip . -x "*.pyc" "*__pycache__*" "*.dist-info/*"
      
      - name: Check layer size
        run: |
          SIZE_BYTES=$(stat -c%s layer.zip)
          SIZE_MB=$((SIZE_BYTES / 1024 / 1024))
          echo "ðŸ“¦ OCR2 Layer size: ${SIZE_MB}MB (${SIZE_BYTES} bytes)"
          ls -lh layer.zip
          du -sh layer/python
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload to S3
        run: |
          aws s3 cp layer.zip s3://${{ secrets.AWS_BUCKET_NAME }}/layers/${{ secrets.OCR2_LAYER_NAME }}.zip

      - name: Publish layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name "${{ secrets.OCR2_LAYER_NAME }}" \
            --content S3Bucket=${{ secrets.AWS_BUCKET_NAME }},S3Key=layers/${{ secrets.OCR2_LAYER_NAME }}.zip \
            --compatible-runtimes python3.11 \
            --query 'LayerVersionArn' --output text)
          echo "âœ… Published: $LAYER_ARN"

  deploy-ocr3-layer:
    needs: detect-layer-changes
    if: needs.detect-layer-changes.outputs.ocr3 == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Build layer
        run: |
          mkdir -p layer/python
          pip install --platform manylinux2014_x86_64 --only-binary=:all: \
            -r shared/ocr_requirement_layer_3.txt -t layer/python
          
          # Remove unnecessary files  
          find layer/python -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find layer/python -type d -name "*.dist-info" -exec rm -rf {} + 2>/dev/null || true
          find layer/python -type f -name "*.pyc" -delete
          find layer/python -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
          
          cd layer
          zip -r9 ../layer.zip . -x "*.pyc" "*__pycache__*" "*.dist-info/*"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Publish layer
        run: |
          LAYER_ARN=$(aws lambda publish-layer-version \
            --layer-name ocr3 \
            --zip-file fileb://layer.zip \
            --compatible-runtimes python3.11 \
            --query 'LayerVersionArn' --output text)
          echo "âœ… Published: $LAYER_ARN"