name: Deploy Services

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      site: ${{ steps.filter.outputs.site }}
      app: ${{ steps.filter.outputs.app }}
      admin: ${{ steps.filter.outputs.admin }}
      api: ${{ steps.filter.outputs.api }}
      auth: ${{ steps.filter.outputs.auth }}
      warp: ${{ steps.filter.outputs.warp }}
      cron: ${{ steps.filter.outputs.cron }}
      train: ${{ steps.filter.outputs.train }}
      ocr: ${{ steps.filter.outputs.ocr }}
      predict: ${{ steps.filter.outputs.predict }}
      shared: ${{ steps.filter.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            site: 'site/**'
            app: 'app/**'
            admin: 'admin/**'
            api: 'api/**'
            auth: 'auth/**'
            warp: 'warp/**'
            cron: 'cron/**'
            train: 'train/**'
            ocr: 'ocr/**'
            predict: 'predict/**'
            shared: 'shared/*_requirement_layer.txt'

  deploy-site:
    needs: detect-changes
    if: needs.detect-changes.outputs.site == 'true'
    uses: ./.github/workflows/cloudflare-pages.yml
    secrets: inherit
    with:
      project-name: site
      working-directory: ./site

  deploy-app:
    needs: detect-changes
    if: needs.detect-changes.outputs.app == 'true'
    uses: ./.github/workflows/cloudflare-pages.yml
    secrets: inherit
    with:
      project-name: app
      working-directory: ./app

  deploy-admin:
    needs: detect-changes
    if: needs.detect-changes.outputs.admin == 'true'
    uses: ./.github/workflows/cloudflare-pages.yml
    secrets: inherit
    with:
      project-name: admin
      working-directory: ./admin

  deploy-api:
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true'
    uses: ./.github/workflows/cloudflare-workers.yml
    secrets: inherit
    with:
      working-directory: ./api

  deploy-auth:
    needs: detect-changes
    if: needs.detect-changes.outputs.auth == 'true'
    uses: ./.github/workflows/cloudflare-workers.yml
    secrets: inherit
    with:
      working-directory: ./auth

  deploy-warp:
    needs: detect-changes
    if: needs.detect-changes.outputs.warp == 'true'
    uses: ./.github/workflows/aws-lambda-with-layer.yml
    secrets: inherit
    with:
      function-name: warp
      working-directory: ./warp

  deploy-cron:
    needs: detect-changes
    if: needs.detect-changes.outputs.cron == 'true'
    uses: ./.github/workflows/aws-lambda.yml
    secrets: inherit
    with:
      function-name: cron
      working-directory: ./cron

  deploy-train:
    needs: detect-changes
    if: needs.detect-changes.outputs.train == 'true'
    uses: ./.github/workflows/aws-lambda.yml
    secrets: inherit
    with:
      function-name: train
      working-directory: ./train

  deploy-ocr:
    needs: detect-changes
    if: needs.detect-changes.outputs.ocr == 'true'
    uses: ./.github/workflows/aws-lambda.yml
    secrets: inherit
    with:
      function-name: ocr
      working-directory: ./ocr

  deploy-predict:
    needs: detect-changes
    if: needs.detect-changes.outputs.predict == 'true'
    uses: ./.github/workflows/aws-lambda-with-layer.yml
    secrets: inherit
    with:
      function-name: predict
      working-directory: ./predict
      download-model: true

  deploy-layers:
    needs: detect-changes
    if: needs.detect-changes.outputs.layers == 'true'
    uses: ./.github/workflows/deploy-layers.yml
    secrets: inherit